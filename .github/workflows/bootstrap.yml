name: Ansible Bootstrapping

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 1

      - uses: actions/setup-python@v2
        with:
          python-version: '3.8'

      - name: Install Ansible + deps
        run: |
            pip install -r bootstrap-instances/requirements.txt

      - name: Setup SSH Keys
        run: |
            echo "${{ secrets.GAT_EU }}" > bootstrap-instances/admintraining-eu.key
            echo "${{ secrets.GAT_BE }}" > bootstrap-instances/admintraining-be.key
            echo "${{ secrets.GAT_OZ }}" > bootstrap-instances/admintraining-oz3.key
            echo "${{ secrets.GAT_US }}" > bootstrap-instances/admintraining-us.key
            echo "${{ secrets.THE_ONE_KEY }}" > bootstrap-instances/gat-one-key-to-rule-them-all
            echo "${{ secrets.THE_ONE_KEY_PUB }}" > bootstrap-instances/gat-one-key-to-rule-them-all.pub
            mkdir -p ~/.ssh
            chmod 600 ~/.ssh
            cat >> ~/.ssh/config <<-END
                Host gat-*training.galaxyproject.eu
                    User ubuntu
                    UserKnownHostsFile /dev/null
                    StrictHostKeyChecking no
            END
            chmod 640 ~/.ssh/config

      - name: Run the playbook
        run: |
            cd bootstrap-instances
            make prep
        env:
            ANSIBLE_STDOUT_CALLBACK: yaml
